<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MN-Pro Control</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* شاشة الدخول */
        #login-screen {
            background: var(--card-bg);
            padding: 40px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            margin-top: 50px;
        }

        .logo-area i { font-size: 50px; color: var(--primary); margin-bottom: 10px; }
        
        input {
            width: 100%;
            padding: 16px;
            margin: 20px 0;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 20px;
            text-align: center;
            text-transform: uppercase;
            font-family: monospace;
            font-weight: bold;
            box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); outline: none; }

        button.main-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
            font-family: 'Tajawal', sans-serif;
        }

        /* لوحة التحكم */
        #dashboard { display: none; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }

        .device-id { font-weight: bold; color: var(--primary); }
        .logout-btn { color: var(--danger); cursor: pointer; font-size: 20px; }

        .status-bar {
            text-align: center;
            font-size: 12px;
            margin-bottom: 15px;
            color: #6b7280;
        }
        .connected { color: var(--success); }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 أعمدة */
            gap: 12px;
        }

        .relay-card {
            background: var(--card-bg);
            padding: 15px 10px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .relay-title { font-size: 14px; font-weight: bold; color: #4b5563; margin-bottom: 10px; display: block; }
        
        .toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        /* حالات الزر */
        .btn-off { background: #e5e7eb; color: #9ca3af; }
        .btn-on { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: scale(1.05);
        }

        .state-text {
            display: block;
            margin-top: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        .text-on { color: var(--success); }
        .text-off { color: #9ca3af; }

    </style>
</head>
<body>

<div class="container">
    
    <div id="login-screen">
        <div class="logo-area">
            <i class="fas fa-microchip"></i>
            <h2>MN Smart System</h2>
        </div>
        <p style="color:#6b7280;">أدخل الكود الموجود خلف الجهاز</p>
        <input type="text" id="devCode" placeholder="MN-XXXXXX" maxlength="15">
        <button class="main-btn" onclick="connectToDevice()">دخول للنظام</button>
    </div>

    <div id="dashboard">
        <div class="header">
            <div>
                <small>الجهاز المتصل</small><br>
                <span class="device-id" id="dispCode">...</span>
            </div>
            <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
            </div>
        </div>

        <div class="status-bar">
            <i class="fas fa-wifi"></i> حالة السيرفر: <span id="connStatus">جاري الاتصال...</span>
        </div>

        <div class="grid" id="relays-grid">
            </div>
    </div>

</div>

<script>
    // إعدادات فايربيس
    const firebaseConfig = {
        databaseURL: "https://mn-pro-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myDeviceID = "";

    // عند فتح الصفحة، تحقق من وجود كود محفوظ
    window.onload = function() {
        const saved = localStorage.getItem("mn_device_sn");
        if(saved) {
            document.getElementById('devCode').value = saved;
            connectToDevice();
        }
    };

    function connectToDevice() {
        const code = document.getElementById('devCode').value.trim().toUpperCase();
        if(code.length < 5) {
            alert("⚠️ يرجى إدخال كود جهاز صحيح");
            return;
        }

        myDeviceID = code;
        localStorage.setItem("mn_device_sn", myDeviceID);

        // تبديل الشاشات
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('dispCode').innerText = myDeviceID;

        // مراقبة الاتصال بالسيرفر
        db.ref('.info/connected').on('value', function(snap) {
            const statusEl = document.getElementById('connStatus');
            if (snap.val() === true) {
                statusEl.innerText = "متصل ✅";
                statusEl.classList.add('connected');
            } else {
                statusEl.innerText = "غير متصل ❌";
                statusEl.classList.remove('connected');
            }
        });

        generateButtons();
    }

    function logout() {
        localStorage.removeItem("mn_device_sn");
        location.reload();
    }

    // توليد 9 أزرار
    function generateButtons() {
        const grid = document.getElementById('relays-grid');
        grid.innerHTML = "";

        for(let i=0; i<9; i++) {
            grid.innerHTML += `
                <div class="relay-card">
                    <span class="relay-title">خط ${i+1}</span>
                    <button id="btn-${i}" class="toggle-btn btn-off" onclick="toggleRelay(${i})">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <span id="txt-${i}" class="state-text text-off">مطفأ</span>
                </div>
            `;
            listenToRelay(i);
        }
    }

    // الاستماع للتغييرات الحية
    function listenToRelay(index) {
        db.ref('devices/' + myDeviceID + '/r' + index).on('value', (snap) => {
            const state = snap.val();
            const btn = document.getElementById('btn-' + index);
            const txt = document.getElementById('txt-' + index);

            if(state == 1) {
                btn.className = "toggle-btn btn-on";
                txt.innerText = "يعمل";
                txt.className = "state-text text-on";
            } else {
                btn.className = "toggle-btn btn-off";
                txt.innerText = "مطفأ";
                txt.className = "state-text text-off";
            }
        });
    }

    // إرسال الأمر (عكس الحالة الحالية)
    function toggleRelay(index) {
        const ref = db.ref('devices/' + myDeviceID + '/r' + index);
        ref.once('value', (snap) => {
            const current = snap.val() || 0;
            ref.set(current == 1 ? 0 : 1);
        });
    }
</script>

</body>
</html>